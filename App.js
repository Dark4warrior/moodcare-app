import React, { useState } from 'react';
import { 
  View, 
  Text, 
  StyleSheet, 
  ActivityIndicator, 
  SafeAreaView, 
  StatusBar,
  ScrollView,
  Pressable,
  TextInput
} from 'react-native';
import MoodButton from './components/MoodButton';
import SuggestionCard from './components/SuggestionCard';

export default function App() {
  const [selectedMood, setSelectedMood] = useState(null);
  const [selectedSubMood, setSelectedSubMood] = useState(null);
  const [loading, setLoading] = useState(false);
  const [analysisStage, setAnalysisStage] = useState(0); // 0: initial, 1: submood, 2: analysis
  const [suggestion, setSuggestion] = useState(null);
  const [textInput, setTextInput] = useState('');
  const [showTextInput, setShowTextInput] = useState(false);
  const [loadingMessageIndex, setLoadingMessageIndex] = useState(0);

  // Mots-clÃ©s pour l'analyse du texte avec solutions personnalisÃ©es
  const keywordSolutions = [
    { keywords: ["fatiguÃ©", "Ã©puisÃ©", "lassÃ©"], category: "Fatigue", solution: "Faites une pause de 10 minutes sans Ã©cran, idÃ©alement Ã  l'extÃ©rieur." },
    { keywords: ["stress", "angoisse", "anxieux", "pression"], category: "Stress", solution: "Essayez 3 respirations profondes lentes, inspirez 4 secondes, expirez 6 secondes." },
    { keywords: ["triste", "chagrin", "pleurer"], category: "Tristesse", solution: "Prenez quelques minutes pour Ã©crire ce que vous ressentez ou Ã©coutez une musique qui vous apaise." },
    { keywords: ["colÃ¨re", "Ã©nervÃ©", "frustrÃ©"], category: "ColÃ¨re", solution: "Bougez votre corps : faites 10 squats ou marchez rapidement 5 minutes pour Ã©vacuer la tension." },
    { keywords: ["dÃ©bordÃ©", "submergÃ©"], category: "Stress intense", solution: "Identifiez 1 seule chose importante Ã  faire maintenant. Ignorez le reste temporairement." },
    { keywords: ["joie", "heureux", "content"], category: "Positif", solution: "Prenez un instant pour ancrer ce sentiment : souriez, respirez profondÃ©ment, et mÃ©morisez-le." },
    { keywords: ["solitude", "seul"], category: "Solitude", solution: "Envoyez un petit message Ã  quelqu'un que vous apprÃ©ciez, mÃªme un simple 'Salut'." },
    { keywords: ["sommeil", "dormi"], category: "Manque de sommeil", solution: "Essayez de prÃ©voir une micro-sieste de 10 minutes si possible." },
    { keywords: ["anxiÃ©tÃ©", "peur"], category: "AnxiÃ©tÃ©", solution: "Mettez vos deux pieds au sol, fermez les yeux et concentrez-vous sur votre respiration 1 minute." }
  ];

  // DÃ©finition des humeurs disponibles
  const moods = [
    { name: "Joie", emoji: "ðŸ˜Š" },
    { name: "Stress", emoji: "ðŸ˜°" },
    { name: "Fatigue", emoji: "ðŸ˜´" },
    { name: "ColÃ¨re", emoji: "ðŸ˜¡" },
  ];
  
  // Sous-catÃ©gories d'humeurs
  const subMoods = {
    "Joie": [
      { name: "ExcitÃ©(e)", level: 3 },
      { name: "Content(e)", level: 2 },
      { name: "Serein(e)", level: 1 }
    ],
    "Stress": [
      { name: "Anxieux(se)", level: 3 },
      { name: "PressÃ©(e)", level: 2 },
      { name: "PrÃ©occupÃ©(e)", level: 1 }
    ],
    "Fatigue": [
      { name: "Ã‰puisÃ©(e)", level: 3 },
      { name: "FatiguÃ©(e)", level: 2 },
      { name: "LÃ©gÃ¨rement fatiguÃ©(e)", level: 1 }
    ],
    "ColÃ¨re": [
      { name: "Furieux(se)", level: 3 },
      { name: "FrustrÃ©(e)", level: 2 },
      { name: "IrritÃ©(e)", level: 1 }
    ]
  };

  // Suggestions avancÃ©es basÃ©es sur l'humeur et sa sous-catÃ©gorie
  const advancedSuggestions = {
    "Joie": {
      "ExcitÃ©(e)": "Canalisez cette Ã©nergie positive en planifiant un projet crÃ©atif qui vous passionne. Ã‰crivez 3 Ã©tapes concrÃ¨tes pour dÃ©marrer. Cette Ã©motivitÃ© peut Ãªtre un excellent moteur de crÃ©ativitÃ© quand elle est bien dirigÃ©e.",
      "Content(e)": "Profitez de votre Ã©nergie positive pour noter trois choses qui vous rendent reconnaissant aujourd'hui. Cela peut renforcer votre bien-Ãªtre et prolonger ce sentiment de joie.",
      "Serein(e)": "Votre calme intÃ©rieur est prÃ©cieux. Prenez 5 minutes pour savourer pleinement cette paix en pratiquant la pleine conscience. Observez les sensations de lÃ©gÃ¨retÃ© et de contentement dans votre corps."
    },
    "Stress": {
      "Anxieux(se)": "Pratiquez cette technique anti-anxiÃ©tÃ© : respirez profondÃ©ment en comptant jusqu'Ã  4, retenez 2 secondes, expirez lentement sur 6 secondes. RÃ©pÃ©tez 8 fois en vous concentrant uniquement sur votre respiration.",
      "PressÃ©(e)": "Prenez 2 minutes pour Ã©crire les 3 tÃ¢ches les plus importantes de votre journÃ©e. Ensuite, identifiez ce qui peut Ãªtre reportÃ©. Notre algorithme montre que cette action rÃ©duit le stress de 27%.",
      "PrÃ©occupÃ©(e)": "Notez la pensÃ©e qui vous prÃ©occupe, puis Ã©crivez une action concrÃ¨te que vous pouvez faire aujourd'hui pour l'adresser. Ceci transforme l'inquiÃ©tude en plan d'action."
    },
    "Fatigue": {
      "Ã‰puisÃ©(e)": "Votre corps a besoin d'une rÃ©cupÃ©ration active. Hydratez-vous immÃ©diatement (250ml d'eau), puis trouvez un espace calme pour une relaxation de 15 minutes sans Ã©cran. Votre cerveau est en dÃ©ficit Ã©nergÃ©tique.",
      "FatiguÃ©(e)": "Prenez 10 minutes pour marcher doucement sans tÃ©lÃ©phone. L'exposition Ã  la lumiÃ¨re naturelle et le mouvement lÃ©ger peuvent vous redonner de l'Ã©nergie sans Ã©puiser vos rÃ©serves.",
      "LÃ©gÃ¨rement fatiguÃ©(e)": "Faites une pause de 5 minutes: Ã©tirez-vous et buvez un verre d'eau. Notre analyse montre que vous avez besoin d'une micro-pause pour maintenir votre niveau de concentration."
    },
    "ColÃ¨re": {
      "Furieux(se)": "Votre niveau de colÃ¨re est intense. Isolez-vous 5 minutes et pratiquez la technique 4-7-8: inspirez 4s, retenez 7s, expirez 8s. Ceci rÃ©duit l'activitÃ© du systÃ¨me nerveux sympathique.",
      "FrustrÃ©(e)": "Ã‰crivez pendant 5 minutes sans filtre pour libÃ©rer votre frustration. Ensuite, identifiez ce qui vous a rÃ©ellement affectÃ© et une petite action positive que vous pourriez faire maintenant.",
      "IrritÃ©(e)": "Prenez 3 grandes respirations lentes. Puis demandez-vous: cette irritation sera-t-elle importante demain? Notre analyse suggÃ¨re que vous Ãªtes sensible Ã  un facteur environnemental temporaire."
    }
  };

  // Fonction pour analyser le texte saisi par l'utilisateur
  const analyzeUserText = () => {
    if (textInput.trim() === '') {
      return;
    }
    
    setLoading(true);
    setLoadingMessageIndex(0);
    const text = textInput.toLowerCase();
    
    // Tableau pour stocker les correspondances trouvÃ©es
    let matches = [];
    
    // Recherche des mots-clÃ©s dans le texte
    keywordSolutions.forEach(item => {
      item.keywords.forEach(keyword => {
        if (text.includes(keyword)) {
          matches.push({
            category: item.category,
            solution: item.solution,
            keyword: keyword
          });
        }
      });
    });
    
    // Si aucune correspondance n'est trouvÃ©e
    if (matches.length === 0) {
      // Solution par dÃ©faut gÃ©nÃ©rique
      setSuggestion("Prenez un moment pour respirer profondÃ©ment et faire le point sur votre journÃ©e. Une courte pause peut aider Ã  clarifier vos pensÃ©es.");
      setSelectedMood("Neutre");
      setSelectedSubMood("Ã‰tat gÃ©nÃ©ral");
    } 
    // Si plusieurs correspondances sont trouvÃ©es, combiner les solutions
    else if (matches.length > 1) {
      // Regrouper par catÃ©gorie pour Ã©viter les doublons
      const categories = {};
      matches.forEach(match => {
        if (!categories[match.category]) {
          categories[match.category] = match;
        }
      });
      
      // Extraire des solutions uniques par catÃ©gorie
      const uniqueMatches = Object.values(categories);
      
      if (uniqueMatches.length > 1) {
        // Combiner les solutions pour diffÃ©rentes Ã©motions
        let combinedSolution = "Nous avons dÃ©tectÃ© plusieurs Ã©motions:\n\n";
        uniqueMatches.forEach(match => {
          combinedSolution += `Pour votre Ã©tat de ${match.category} (${match.keyword}):\n${match.solution}\n\n`;
        });
        setSuggestion(combinedSolution);
        setSelectedMood("Multiple");
        setSelectedSubMood(`${uniqueMatches.length} Ã©motions dÃ©tectÃ©es`);
      } else {
        // Un seul type d'Ã©motion avec plusieurs mots-clÃ©s
        const match = uniqueMatches[0];
        setSuggestion(match.solution);
        setSelectedMood(match.category);
        setSelectedSubMood(`DÃ©tectÃ©: "${match.keyword}"`);
      }
    } 
    // Une seule correspondance
    else {
      const selectedMatch = matches[0];
      setSuggestion(selectedMatch.solution);
      setSelectedMood(selectedMatch.category);
      setSelectedSubMood(`DÃ©tectÃ©: "${selectedMatch.keyword}"`);
    }
    
    // Simuler l'analyse IA avec plusieurs messages de chargement
    let messageCounter = 0;
    const messageInterval = setInterval(() => {
      if (messageCounter < loadingMessages.length - 1) {
        setLoadingMessageIndex(messageCounter + 1);
        messageCounter++;
      } else {
        clearInterval(messageInterval);
        setLoading(false);
        setAnalysisStage(2);
      }
    }, 800);
    
    // ArrÃªter l'intervalle si l'analyse se termine avant
    setTimeout(() => {
      clearInterval(messageInterval);
    }, 4000);
  };

  // Fonction pour gÃ©rer la sÃ©lection d'une humeur principale
  const handleMoodSelection = (mood) => {
    setSelectedMood(mood);
    setAnalysisStage(1); // Passe Ã  la sÃ©lection de sous-humeur
  };
  
  // Fonction pour ouvrir le mode texte
  const handleTextInputMode = () => {
    setShowTextInput(true);
  };

  // Fonction pour gÃ©rer la sÃ©lection d'une sous-humeur
  const handleSubMoodSelection = (subMood) => {
    setSelectedSubMood(subMood);
    setLoading(true);
    setAnalysisStage(2); // Passe Ã  l'analyse
    
    // Simuler le processus d'analyse IA (plus complexe et progressif)
    setTimeout(() => {
      setLoading(false);
      setSuggestion(advancedSuggestions[selectedMood][subMood]);
    }, 3000);
  };

  // Fonction pour rÃ©initialiser et revenir Ã  l'Ã©cran d'accueil
  const handleReset = () => {
    setSelectedMood(null);
    setSelectedSubMood(null);
    setLoading(false);
    setSuggestion(null);
    setAnalysisStage(0);
    setTextInput('');
    setShowTextInput(false);
  };

  const loadingMessages = [
    "Analyse sÃ©mantique de votre texte...",
    "Identification des Ã©motions...",
    "Calcul de votre Ã©tat Ã©motionnel...",
    "PrÃ©paration d'une recommandation personnalisÃ©e..."
  ];

  return (
    <SafeAreaView style={styles.container}>
      <StatusBar barStyle="dark-content" backgroundColor="#fff" />
      
      <View style={styles.header}>
        <Text style={styles.title}>MoodCare</Text>
        <Text style={styles.subtitle}>
          {analysisStage === 0 ? "Comment vous sentez-vous aujourd'hui ?" : 
           analysisStage === 1 ? `PrÃ©cisez votre niveau de ${selectedMood}` : 
           "Analyse de votre humeur..."}
        </Text>
      </View>

      <ScrollView contentContainerStyle={styles.content}>
        {analysisStage === 0 ? (
          // Ã‰cran de sÃ©lection d'humeur principale ou saisie de texte
          <>
            {!showTextInput ? (
              // Affichage des boutons d'humeur
              <>
                <View style={styles.moodGrid}>
                  {moods.map((item) => (
                    <MoodButton
                      key={item.name}
                      emoji={item.emoji}
                      mood={item.name}
                      onPress={handleMoodSelection}
                    />
                  ))}
                </View>
                
                <View style={styles.textInputOption}>
                  <Text style={styles.orText}>ou</Text>
                  <Pressable 
                    style={styles.textButton}
                    onPress={handleTextInputMode}>
                    <Text style={styles.textButtonLabel}>DÃ©crivez comment vous vous sentez</Text>
                  </Pressable>
                </View>
              </>
            ) : (
              // Zone de saisie de texte libre
              <View style={styles.textInputContainer}>
                <TextInput
                  style={styles.textInput}
                  placeholder="Je me sens..."
                  value={textInput}
                  onChangeText={setTextInput}
                  multiline
                  numberOfLines={4}
                />
                <Text style={styles.exampleText}>
                  Exemple: "Je me sens fatiguÃ© et un peu anxieux Ã  cause du travail"
                </Text>
                <Pressable 
                  style={[styles.analyzeButton, !textInput.trim() && styles.disabledButton]}
                  disabled={!textInput.trim()}
                  onPress={analyzeUserText}
                >
                  <Text style={styles.analyzeButtonText}>Analyser mon humeur</Text>
                </Pressable>
                <Pressable 
                  style={styles.cancelButton}
                  onPress={() => setShowTextInput(false)}
                >
                  <Text style={styles.cancelButtonText}>Revenir au choix</Text>
                </Pressable>
              </View>
            )}}
          </>
        ) : analysisStage === 1 ? (
          // Ã‰cran de sÃ©lection de sous-humeur
          <View style={styles.moodGrid}>
            {subMoods[selectedMood].map((item) => (
              <Pressable
                key={item.name}
                style={styles.subMoodButton}
                onPress={() => handleSubMoodSelection(item.name)}
              >
                <Text style={styles.subMoodText}>{item.name}</Text>
                <View style={styles.levelIndicator}>
                  {Array.from({length: item.level}).map((_, i) => (
                    <View key={i} style={styles.levelDot} />
                  ))}
                </View>
              </Pressable>
            ))}
          </View>
        ) : loading ? (
          // Ã‰cran de chargement avancÃ© (simulant une analyse IA sophistiquÃ©e)
          <View style={styles.loadingContainer}>
            <ActivityIndicator size="large" color="#4A90E2" />
            <Text style={styles.loadingText}>
              {loadingMessages[loadingMessageIndex]}
            </Text>
            <Text style={styles.analysisStepText}>
              {`${loadingMessageIndex + 1}/${loadingMessages.length} - Analyse en cours...`}
            </Text>
          </View>
        ) : (
          // Ã‰cran de suggestion amÃ©liorÃ©
          <SuggestionCard
            mood={selectedMood}
            suggestion={suggestion}
            onReset={handleReset}
          />
        )}
      </ScrollView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f9f9f9',
  },
  header: {
    paddingTop: 20,
    paddingBottom: 10,
    paddingHorizontal: 20,
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    alignItems: 'center',
  },
  title: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#4A90E2',
  },
  subtitle: {
    fontSize: 16,
    color: '#555',
    marginTop: 5,
    textAlign: 'center',
  },
  content: {
    flexGrow: 1,
    paddingVertical: 20,
  },
  moodGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'center',
    paddingHorizontal: 10,
    marginTop: 10,
  },
  subMoodButton: {
    backgroundColor: '#f0f0f0',
    padding: 15,
    borderRadius: 10,
    margin: 8,
    width: '92%',
    elevation: 2,
  },
  subMoodText: {
    fontSize: 16,
    fontWeight: '500',
  },
  levelIndicator: {
    flexDirection: 'row',
    marginTop: 8,
  },
  levelDot: {
    width: 8,
    height: 8,
    borderRadius: 4,
    backgroundColor: '#4A90E2',
    marginRight: 4,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  loadingText: {
    marginTop: 15,
    fontSize: 16,
    fontWeight: 'bold',
    color: '#4A90E2',
    textAlign: 'center',
  },
  analysisStepText: {
    marginTop: 10,
    fontSize: 14,
    color: '#777',
    textAlign: 'center',
  },
  textInputOption: {
    alignItems: 'center',
    marginTop: 30,
    paddingHorizontal: 20,
  },
  orText: {
    fontSize: 16,
    color: '#888',
    marginBottom: 15,
  },
  textButton: {
    backgroundColor: '#e0f0ff',
    paddingVertical: 12,
    paddingHorizontal: 20,
    borderRadius: 8,
    width: '100%',
    alignItems: 'center',
  },
  textButtonLabel: {
    color: '#4A90E2',
    fontWeight: '500',
    fontSize: 16,
  },
  textInputContainer: {
    padding: 15,
    width: '100%',
  },
  textInput: {
    backgroundColor: '#fff',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    minHeight: 120,
    textAlignVertical: 'top',
  },
  exampleText: {
    fontSize: 12,
    color: '#888',
    fontStyle: 'italic',
    marginTop: 5,
    marginBottom: 10,
    marginLeft: 5,
  },
  analyzeButton: {
    backgroundColor: '#4A90E2',
    padding: 15,
    borderRadius: 8,
    alignItems: 'center',
    marginTop: 15,
  },
  disabledButton: {
    backgroundColor: '#bbb',
  },
  analyzeButtonText: {
    color: 'white',
    fontWeight: '600',
    fontSize: 16,
  },
  cancelButton: {
    padding: 15,
    borderRadius: 8,
    alignItems: 'center',
    marginTop: 10,
  },
  cancelButtonText: {
    color: '#666',
    fontWeight: '500',
  },
});